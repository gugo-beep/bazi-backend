// gugo-beep/bazi-backend/bazi-backend-18275ce3be8ede12177b43420d0b622777a7d327/src/update-frontend-mock.js

import { findPossibleGregorianDates, generateBaziProfile } from './baziService.js';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const userInput = process.argv[2]; 
const genderArg = process.argv[3];

if (!userInput || !genderArg) {
    console.error("\nâŒ é”™è¯¯ï¼šè¯·æä¾›æ—¥æœŸå’Œæ€§åˆ«ï¼");
    console.error("ç”¨æ³•ç¤ºä¾‹:");
    console.error("  å…¬å†: node src/update-frontend-mock.js \"1996-04-13 00:18:00\" å¥³");
    console.error("  å†œå†: node src/update-frontend-mock.js \"lunar:äºŒã€‡ã€‡ä¸€å¹´é—°å…«æœˆåå›› 08:00\" å¥³");
    console.error("  å››æŸ±: node src/update-frontend-mock.js \"pillars:ä¸™å­-å£¬è¾°-åºšè¾°-ä¸™å­\" å¥³\n");
    process.exit(1);
}

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const frontendMockFilePath = path.resolve(__dirname, '../../bazi-frontend/src/app/mock-bazi-data.ts');
const localOutputPath = path.resolve(__dirname, '../bazi-output.json');

async function main() {
    try {
        console.log(`ğŸš€ æ­¥éª¤ 1: æ­£åœ¨ä¸ºè¾“å…¥ "${userInput}" æŸ¥æ‰¾å¯èƒ½çš„å…¬å†æ—¥æœŸ...`);
        const possibleDates = await findPossibleGregorianDates(userInput);

        if (possibleDates.length === 0) {
            console.error('\nâŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä¸è¾“å…¥åŒ¹é…çš„æœ‰æ•ˆå…¬å†æ—¥æœŸã€‚');
            console.error('è¯·æ£€æŸ¥æ‚¨çš„è¾“å…¥æ˜¯å¦æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯å†œå†æ—¥æœŸæ˜¯å¦å­˜åœ¨ã€‚');
            process.exit(1);
        }

        let chosenDate;

        if (possibleDates.length > 1) {
            console.warn(`\nâš ï¸ æ³¨æ„ï¼šæ‚¨è¾“å…¥çš„å››æŸ±å¯¹åº” ${possibleDates.length} ä¸ªå¯èƒ½çš„å…¬å†æ—¥æœŸã€‚`);
            console.log('è¯·ä»ä»¥ä¸‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œå¹¶ç”¨å®ƒä½œä¸ºæ—¥æœŸå‚æ•°é‡æ–°è¿è¡Œå‘½ä»¤ï¼š\n');
            possibleDates.forEach((date, index) => {
                console.log(`  [${index + 1}] "${date}"`);
            });
            console.log('\nä¾‹å¦‚: npm run update-mock -- "1996-04-13 00:18:00" å¥³');
            process.exit(1); // æ­£å¸¸é€€å‡ºï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ
        } else {
            chosenDate = possibleDates[0];
            console.log(`âœ… æ‰¾åˆ°å”¯ä¸€åŒ¹é…çš„å…¬å†æ—¥æœŸ: ${chosenDate}`);
        }

        console.log(`\nğŸš€ æ­¥éª¤ 2: æ­£åœ¨ä¸º "${chosenDate}" (${genderArg}) ç”Ÿæˆå…«å­—æ•°æ®å¹¶æ›´æ–°å‰ç«¯...`);
        
        const baziData = await generateBaziProfile(chosenDate, genderArg);
        
        const tsFileContent = `// [Auto-generated by bazi-backend]\n// Case: ${userInput} (${genderArg})\n// Last updated: ${new Date().toLocaleString()}\n\nimport { BaziData } from "./bazi.interface";\n\nexport const mockBaziData: BaziData = ${JSON.stringify(baziData, null, 2)};\n`;

        fs.writeFileSync(frontendMockFilePath, tsFileContent);
        fs.writeFileSync(localOutputPath, JSON.stringify(baziData, null, 2));

        console.log(`\nâœ… å…¨éƒ¨æˆåŠŸï¼`);
        console.log(` -> å‰ç«¯ mock æ–‡ä»¶å·²æ›´æ–°: ${frontendMockFilePath}`);
        console.log(` -> æœ¬åœ° JSON æ–‡ä»¶å·²ç”Ÿæˆ: ${localOutputPath}`);

        process.exit(0);

    } catch (error) {
        console.error("\nâŒ æ“ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:", error.message);
        process.exit(1);
    }
}

main();